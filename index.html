<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>Field Run</title>
        <meta name="description"content="Site internet v.0 de l'application Field Run">
        <link rel="icon" type="image/png" sizes="32x32" href="images">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
            <style>
                
            html, body { 
                height: 100%
                margin: 0;
                }
            
            #map {
                height: 100%;
                width: 50%;
                position: relative;
                }

            #Btnstart {
                position: fixed;
                height: 15vh;
                width:  15vw;
                z-index: 9998;
                top: 85%;
                left: 50%;
                transform: translate(-50%, -50%);
                border: 1.5px solid black;
                border-radius: 10px;
                font-size: 35px;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #F0C900;
                color: white;
                font-family: "RushDriver", Helvetica, sans-serif;
                -webkit-text-stroke: 1px black;
                }
@font-face {
    font-family: "RushDriver";
    src: url("../polices/RushDriver.otf") format("opentype");
    }


           


        /* cercle de chargement*/
            :root {
                --loader-visible: "0"; /*0 = caché, 1 = visible*/
                }

            #loader {
                border-radius: 50%;
                position: fixed;
                z-index: 9999;
                width: 58px;       /*taille*/
                height: 58px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: conic-gradient(black, white);   /*dégradé*/
                opacity: calc(var(--loader-visible) * 1);  /*utilisation de la variable pour opacitée*/
                pointer-events: none;   /*pour que ca ne bloque pas le chargement de la carte*/
                transition: opacity 0.3s;

                -webkit-mask: radial-gradient(            /*masque de transparence*/
                    farthest-side,
                    transparent calc(100% - 8px),
                    black calc(100% - 8px)
                );
                mask: radial-gradient(
                    farthest-side,
                    transparent calc(100% - 8px),
                    black calc(100% - 8px)
                );

                animation: spin 2s linear infinite;  /*animation tourner*/
            }

@keyframes spin {
    to{
        transform: translate(-50%, -50%) rotate(-360deg);
        }
    }
            </style>
    </head>

    
    <body>
        <div id="map"></div>
        <div id="loader" class="carre"></div>
        <div id="Btnstart" class="button">Run</div>
        
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            //====================
//Variables
//====================

//Carte
        let map;
//Marqueur
        let currentMarker;
//Cercle de précision
        let accuracyCircle = null;
//Première initialisation
        let firstFix = true;
//Tableau d'historique de position
        let coords = [];
//Ligne
        let line;

//====================
//Fonctions
//====================

//Fonctions Loader
    function showLoader(){
        document.documentElement.style.setProperty("--loader-visible", "1");
    }

    function hideLoader() {
        document.documentElement.style.setProperty("--loader-visible", "0");
    }


    function init() {
        initMap();
        initMarker();
        initTrackingLine();
        initGPS();
        
    }

    function initMap() {
        //CARTE        
//Crée une carte Leaflet avec ID "map"
//SetView([lat, lon], zoom)
        map = L.map('map').setView([0, 0], 13);

//Ajoute les tuiles (images de carte) depuis OpenStreetMap
// {z}/{x}/{y} = système de coordonnées des tuiles
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' //obligation légale
    }).addTo(map);
    }

    function initMarker() {
        //MARQUEUR
//Crée un marqeur au point [0,0] au départ (déplacé plus tard avec le GPS)
        currentMarker = L.marker([0,0]).addTo(map)
        .bindPopup('Tu es là')  //texte affiché si on clique
        .openPopup();           //ouvre le popup automatiquement
    }

    function initGPS() {

        if ("geolocation" in navigator) { //===============
//watchPosition = surveille la position en continu
            navigator.geolocation.watchPosition( //-----------------------------WATCH POSITION
                updatePosition,                                            //===============
                handleError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 75000
                }
            );

        } else {
            alert("GPS non disponible sur ce navigateur");
        }
    }

        function initTrackingLine() {
        line = L.polyline(coords, {
            color: "#5F2EFF", //2800A8
            fillOpacity: 0.9,
            weight: 4,
        }).addTo(map);
    }

    function updatePosition(position) {

//Récupère les coordonnées
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
//Récupère la précision en mètres
        const accuracy = position.coords.accuracy;

//Déplace le marqueur vers la nouvelle position
        currentMarker.setLatLng([lat, lon]);

        if (firstFix) {
            map.setView([lat, lon], 16); // centre + zoom fort
            firstFix = false;
            hideLoader();
        } else {
            map.panTo([lat, lon]);       // déplacement doux
        }

        if (accuracyCircle) {

//Si le cercle existe déja, on le déplace
            accuracyCircle
                .setLatLng([lat, lon])
                .setRadius(accuracy);

//Sinon on le crée
        } else{
            accuracyCircle = L.circle([lat, lon], {
                radius: accuracy,
                color: accuracy > 100 ? 'red' : 'blue',
                fillOpacity: 0.09
            }).addTo(map);
        }

//Affiche la précision dans la console
        console.log("Précision :", accuracy, "m");

        if (accuracy < 20) {
            coords.push([lat, lon])
            line.setLatLngs(coords);    
        }
    }

    function handleError() {
        alert("GPS refusé ou indisponible");
    }

    function coordinates() {

    }

    
    

//====================
//Lancement
//====================
        
document.addEventListener("DOMContentLoaded", () => {
    showLoader();
    init();
    map.invalidateSize();
});
        </script>
        
    </body>
</html>
<!--Ceci est une note-->
